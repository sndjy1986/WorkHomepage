<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bar Test</title>
  <style>
    body { margin:0; height:100vh; background:#111; color:#fff; font:12px/1 monospace; }
    #net-bar { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around;
      align-items:center; padding:6px 4px; background:rgba(0,0,0,.8); gap:4px; z-index:9998; }
    #net-bar div { white-space:nowrap; }
    #net-bar span { color:#0ff; }
  </style>
</head>
<body>

  <footer id="net-bar">
    <div>IP: <span id="nb-ip">…</span></div>
    <div>Location: <span id="nb-loc">…</span></div>
    <div>ASN: <span id="nb-asn">…</span></div>
    <div>Download: <span id="nb-dl">…</span> Mbps</div>
    <div>Jitter: <span id="nb-jit">…</span> ms</div>
    <div>Ping: <span id="nb-ping">…</span> ms</div>
    <div>Network: <span id="nb-net">…</span></div>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id) => document.getElementById(id);

    // If the footer isn’t on this page, stop.
    const required = ['nb-ip','nb-loc','nb-asn','nb-dl','nb-jit','nb-ping','nb-net'];
    if (!required.every(id => $(id))) return;

    const set = (id, val) => { const el = $(id); if (el) el.textContent = val; };

    // Network type (not supported everywhere)
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    set('nb-net', conn?.effectiveType ? conn.effectiveType.toUpperCase() : '--');

    // IP + location (best effort, avoids needing an ipinfo token)
    fetch('https://api.ipify.org?format=json')
      .then(r => r.json())
      .then(d => {
        set('nb-ip', d.ip);
        return fetch('https://ipapi.co/json/');
      })
      .then(r => r.json())
      .then(g => {
        const loc = (g.city && g.region) ? `${g.city}, ${g.region}` : '--';
        set('nb-loc', loc);
        set('nb-asn', g.asn || '--');
      })
      .catch(() => {
        set('nb-ip', 'ERR'); set('nb-loc', 'ERR'); set('nb-asn', 'ERR');
      });

    // Speed + ping + jitter
    (async () => {
      set('nb-dl', '…'); set('nb-jit', '…'); set('nb-ping', '…');

      try {
        const bytes = 10_000_000;

        // Download speed
        const t0 = performance.now();
        await fetch(`https://speed.cloudflare.com/__down?bytes=${bytes}&t=${Date.now()}`, { cache: 'no-store', mode: 'cors' });
        const downMs = performance.now() - t0;
        const mbps = ((bytes * 8) / 1e6) / (downMs / 1000);
        set('nb-dl', mbps.toFixed(0));

        // Ping (RTT)
        const pingOnce = async () => {
          const start = performance.now();
          await fetch(`https://speed.cloudflare.com/__down?bytes=0&t=${Date.now()}`, { cache: 'no-store', mode: 'cors' });
          return performance.now() - start;
        };

        const pings = [];
        for (let i = 0; i < 5; i++) pings.push(await pingOnce());

        const avg = pings.reduce((a,b) => a + b, 0) / pings.length;
        const jit = Math.sqrt(pings.reduce((a,p) => a + Math.pow(p - avg, 2), 0) / pings.length);

        set('nb-ping', avg.toFixed(0));
        set('nb-jit', jit.toFixed(0));
      } catch {
        set('nb-dl', 'ERR'); set('nb-jit', 'ERR'); set('nb-ping', 'ERR');
      }
    })();

    // Refresh bits every 15s
    setInterval(() => {
      fetch('https://api.ipify.org?format=json', { cache: 'no-store' })
        .then(r => r.json())
        .then(d => set('nb-ip', d.ip))
        .catch(() => set('nb-ip', 'ERR'));

      const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (c?.effectiveType) set('nb-net', c.effectiveType.toUpperCase());
    }, 15000);
  });
  </script>

</body>
</html>
