<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U8 Player • iPad Native/MSE Toggle</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; min-height:100svh; display:grid; place-items:center; background:#0b0c10; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { width:min(100%, 980px); padding:16px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
    .card { background:#111418; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; color:#e8eaed; font-weight:600; }
    .player { position:relative; aspect-ratio:16/9; width:100%; background:#000; border-radius:12px; overflow:hidden; }
    video { width:100%; height:100%; display:block; background:#000; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0; }
    .row > * { flex: 1 1 auto; min-width: 180px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { color:#cbd5e1; font-size:13px; }
    input[type="text"] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#0b0c10; color:#e5e7eb; }
    .btn {
      font:600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:#1f2937; color:#fff; cursor:pointer;
    }
    .log {
      height: 320px; overflow:auto; background:#0b0c10; border-radius:12px; padding:12px;
      font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#e5e7eb;
      border:1px solid rgba(255,255,255,.08);
    }
    .note { color:#cbd5e1; font-size:.95rem; margin:8px 0 0; }
    .err { color:#fecaca; }
    .ok { color:#bbf7d0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>M3U8 Player (iPad Native/MSE Toggle)</h1>

        <div class="row">
          <label for="url">Stream URL</label>
          <input id="url" type="text" value="https://dai2-playlistserver.aws.syncbak.com/media.m3u8?bitrate=3659760&session=1c375518aea64b6c998758e3da4e996e" />
        </div>

        <div class="row controls">
          <label><input type="checkbox" id="forceMSE" /> Force MSE (hls.js)</label>
          <label><input type="checkbox" id="useCreds" /> Use credentials (cookies)</label>
          <button class="btn" id="startBtn">Start</button>
          <button class="btn" id="stopBtn">Stop</button>
        </div>

        <div class="player">
          <video id="video"
            controls
            playsinline
            webkit-playsinline
            x-webkit-airplay="allow"
            preload="metadata">
          </video>
        </div>

        <p class="note" id="status">Idle.</p>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; color:#e8eaed; font-weight:600;">Diagnostics</h2>
        <div class="log" id="log" aria-live="polite"></div>
        <p class="note">
          MediaError codes: 1=ABORTED, 2=NETWORK, 3=DECODE, 4=SRC_NOT_SUPPORTED.  
          If native fails with 4, try “Force MSE”. If MSE fails with CORS errors, try “Use credentials” (server must allow it).
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    (function(){
      const video = document.getElementById('video');
      const urlInput = document.getElementById('url');
      const forceMSE = document.getElementById('forceMSE');
      const useCreds = document.getElementById('useCreds');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const logEl = document.getElementById('log');
      const statusEl = document.getElementById('status');

      let hls = null;

      function log(msg, cls) {
        const time = new Date().toISOString().split('T')[1].replace('Z','');
        const line = document.createElement('div');
        line.textContent = `[${time}] ${msg}`;
        if (cls) line.className = cls;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }
      function setStatus(msg, cls='') {
        statusEl.textContent = msg;
        statusEl.className = `note ${cls}`;
      }
      function explainMediaError(err) {
        if (!err) return 'Unknown';
        const map = { 1:'ABORTED', 2:'NETWORK', 3:'DECODE', 4:'SRC_NOT_SUPPORTED' };
        return `${err.code} (${map[err.code] || 'UNKNOWN'})`;
      }
      function wireVideoEvents() {
        video.addEventListener('loadedmetadata', () => log('Event: loadedmetadata', 'ok'));
        video.addEventListener('canplay', () => log('Event: canplay', 'ok'));
        video.addEventListener('play', () => log('Event: play', 'ok'));
        video.addEventListener('error', () => {
          const err = video.error;
          log(`Video error: ${explainMediaError(err)}`, 'err');
          setStatus(`Video error: ${explainMediaError(err)}.`, 'err');
        });
      }
      wireVideoEvents();

      function destroyHls() {
        if (hls) {
          try { hls.destroy(); } catch {}
          hls = null;
        }
      }

      async function start() {
        destroyHls();
        const src = urlInput.value.trim();
        const useMSE = forceMSE.checked;

        // Clean state
        video.removeAttribute('src');
        video.load();

        if (!useMSE && video.canPlayType('application/vnd.apple.mpegurl')) {
          log('Starting with native HLS.');
          setStatus('Attaching native HLS…');
          video.src = src;
          video.load();
          try {
            await video.play();
            setStatus('Playing (native).', 'ok');
          } catch {
            setStatus('Press play to start (native).');
          }
          return;
        }

        // MSE path via hls.js
        if (!(window.Hls && Hls.isSupported())) {
          log('hls.js not supported on this browser.', 'err');
          setStatus('MSE not supported here.', 'err');
          return;
        }
        setStatus('Attaching hls.js (MSE)…');
        log('Starting with hls.js (MSE).');

        // If server requires cookies, enable withCredentials and ensure CORS is configured correctly on server.
        const creds = !!useCreds.checked;

        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90,
          // XHR setup lets us pass credentials and adjust headers if needed
          xhrSetup: function(xhr, url) {
            xhr.withCredentials = creds;
            // If you need custom headers, uncomment and adjust:
            // xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
          }
        });

        hls.on(Hls.Events.ERROR, (evt, data) => {
          if (!data) return;
          if (data.fatal) {
            log(`hls.js fatal: ${data.type} / ${data.details}`, 'err');
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                setStatus('Network error. Retrying…', 'err');
                hls.startLoad(); break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                setStatus('Media error. Recovering…', 'err');
                hls.recoverMediaError(); break;
              default:
                setStatus('Fatal error. Reinitializing…', 'err');
                destroyHls();
                setTimeout(start, 300);
            }
          } else {
            log(`hls.js non-fatal: ${data.type} / ${data.details}`);
          }
        });

        hls.loadSource(src);
        hls.attachMedia(video);

        try {
          await video.play();
          setStatus('Playing (MSE).', 'ok');
        } catch {
          setStatus('Press play to start (MSE).');
        }
      }

      function stop() {
        setStatus('Stopped.');
        destroyHls();
        video.pause();
        video.removeAttribute('src');
        video.load();
      }

      startBtn.addEventListener('click', start);
      stopBtn.addEventListener('click', stop);
    })();
  </script>
</body>
</html>
