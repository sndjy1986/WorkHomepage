<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U8 Player • iPad Debug</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; min-height:100svh; display:grid; place-items:center; background:#0b0c10; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { width:min(100%, 980px); padding:16px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }
    .card { background:#111418; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px; color:#e8eaed; font-weight:600; }
    .player { position:relative; aspect-ratio:16/9; width:100%; background:#000; border-radius:12px; overflow:hidden; }
    video { width:100%; height:100%; display:block; background:#000; }
    .overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.55));
    }
    .btn {
      font:600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:12px 18px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
      background:#1f2937; color:#fff; cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }
    .small { font-size:12px; opacity:.85; }
    .log {
      height: 320px; overflow:auto; background:#0b0c10; border-radius:12px; padding:12px;
      font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#e5e7eb;
      border:1px solid rgba(255,255,255,.08);
    }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    label { color:#cbd5e1; font-size:13px; }
    input[type="text"] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#0b0c10; color:#e5e7eb; }
    .note { color:#cbd5e1; font-size:.95rem; }
    .err { color:#fecaca; }
    .ok { color:#bbf7d0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>M3U8 Player (iPad-first)</h1>

        <div class="row">
          <label for="url" class="small">Stream URL</label>
          <input id="url" type="text" value="https://dai2-playlistserver.aws.syncbak.com/media.m3u8?bitrate=3659760&session=1c375518aea64b6c998758e3da4e996e" />
        </div>

        <div class="player" id="playerBox">
          <video id="video"
            controls
            playsinline
            webkit-playsinline
            x-webkit-airplay="allow"
            preload="metadata">
            <!-- iOS Safari prefers direct .src assignment, so we leave source empty initially -->
          </video>
          <div class="overlay" id="overlay">
            <button class="btn" id="startBtn">Tap to Start</button>
          </div>
        </div>

        <p class="note" id="status">Idle. Tap Start to attach the stream (required on iOS).</p>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; color:#e8eaed; font-weight:600;">Diagnostics</h2>
        <div class="log" id="log" aria-live="polite"></div>
        <p class="small">
          We log: <code>loadedmetadata</code>, <code>canplay</code>, <code>play</code>, and <code>error</code>.  
          MediaError codes: 1=ABORTED, 2=NETWORK, 3=DECODE, 4=SRC_NOT_SUPPORTED.
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    (function(){
      const video = document.getElementById('video');
      const logEl = document.getElementById('log');
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const overlay = document.getElementById('overlay');
      const urlInput = document.getElementById('url');

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
        || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

      function log(msg, cls) {
        const time = new Date().toISOString().split('T')[1].replace('Z','');
        const line = document.createElement('div');
        line.textContent = `[${time}] ${msg}`;
        if (cls) line.className = cls;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }
      function setStatus(msg, cls='') {
        statusEl.textContent = msg;
        statusEl.className = `note ${cls}`;
      }
      function explainMediaError(err) {
        if (!err) return 'Unknown';
        const map = { 1:'ABORTED', 2:'NETWORK', 3:'DECODE', 4:'SRC_NOT_SUPPORTED' };
        return `${err.code} (${map[err.code] || 'UNKNOWN'})`;
      }

      function attachNative(src) {
        // iOS/iPadOS: best practice is assign .src then load()
        video.src = src;
        video.load();
        log('Native HLS attached to <video>.', 'ok');
      }

      function attachHlsJs(src) {
        if (!(window.Hls && Hls.isSupported())) {
          log('hls.js not supported on this browser.', 'err');
          setStatus('Your browser does not support HLS or MSE.', 'err');
          return null;
        }
        // Only when using MSE
        video.setAttribute('crossorigin', 'anonymous');

        const hls = new Hls({ enableWorker: true, lowLatencyMode: true, backBufferLength: 90 });
        hls.loadSource(src);
        hls.attachMedia(video);
        log('hls.js attached (MSE).', 'ok');

        hls.on(Hls.Events.ERROR, (evt, data) => {
          if (!data) return;
          if (data.fatal) {
            log(`hls.js fatal error: ${data.type} / ${data.details}`, 'err');
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                setStatus('Network error. Retrying…', 'err');
                hls.startLoad(); break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                setStatus('Media error. Recovering…', 'err');
                hls.recoverMediaError(); break;
              default:
                setStatus('Fatal error. Reinitializing…', 'err');
                hls.destroy();
                setTimeout(() => attachHlsJs(src), 300);
            }
          } else {
            log(`hls.js non-fatal: ${data.type} / ${data.details}`);
          }
        });
        return hls;
      }

      function wireEvents() {
        video.addEventListener('loadedmetadata', () => log('Event: loadedmetadata', 'ok'));
        video.addEventListener('canplay', () => log('Event: canplay', 'ok'));
        video.addEventListener('play', () => log('Event: play', 'ok'));
        video.addEventListener('error', () => {
          const err = video.error;
          const msg = `Video error: ${explainMediaError(err)}`;
          log(msg, 'err');
          setStatus(msg + '. If persistent, the server may block cross-origin or require cookies/referrer.', 'err');
        });
      }
      wireEvents();

      startBtn.addEventListener('click', async () => {
        const src = urlInput.value.trim();
        overlay.style.display = 'none';
        setStatus('Starting…');

        try {
          if (isIOS || video.canPlayType('application/vnd.apple.mpegurl')) {
            log('Using native HLS path (iOS/Safari).');
            attachNative(src);
          } else {
            log('Using hls.js (MSE) path.');
            attachHlsJs(src);
          }

          // iOS often requires the user gesture *and* an immediate play()
          video.muted = false; // set true if you want silent autoplay
          try {
            await video.play();
            setStatus('Playing.');
          } catch (e) {
            log('play() was blocked or failed. Waiting for user to press the native play button.', 'err');
            setStatus('Press the play button to start.', 'err');
          }
        } catch (e) {
          log('Startup error: ' + (e && e.message ? e.message : e), 'err');
          setStatus('Startup error. See logs.', 'err');
        }
      });
    })();
  </script>
</body>
</html>
